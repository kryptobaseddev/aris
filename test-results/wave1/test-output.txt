============================= test session starts ==============================
platform linux -- Python 3.13.7, pytest-9.0.1, pluggy-1.6.0 -- /mnt/projects/aris-tool/.venv/bin/python3.13
cachedir: .pytest_cache
rootdir: /mnt/projects/aris-tool
configfile: pyproject.toml
plugins: anyio-4.11.0, cov-7.0.0
collecting ... collected 30 items

tests/unit/test_config.py::TestSecureKeyManager::test_set_and_get_api_key PASSED [  3%]
tests/unit/test_config.py::TestSecureKeyManager::test_get_nonexistent_key PASSED [  6%]
tests/unit/test_config.py::TestSecureKeyManager::test_delete_api_key PASSED [ 10%]
tests/unit/test_config.py::TestSecureKeyManager::test_delete_nonexistent_key PASSED [ 13%]
tests/unit/test_config.py::TestSecureKeyManager::test_set_empty_provider_raises_error PASSED [ 16%]
tests/unit/test_config.py::TestSecureKeyManager::test_set_empty_key_raises_error PASSED [ 20%]
tests/unit/test_config.py::TestSecureKeyManager::test_verify_key_exists PASSED [ 23%]
tests/unit/test_config.py::TestSecureKeyManager::test_list_providers PASSED [ 26%]
tests/unit/test_config.py::TestSecureKeyManager::test_get_all_keys PASSED [ 30%]
tests/unit/test_config.py::TestSecureKeyManager::test_clear_all_keys PASSED [ 33%]
tests/unit/test_config.py::TestConfigManager::test_singleton_pattern PASSED [ 36%]
tests/unit/test_config.py::TestConfigManager::test_reset_instance PASSED [ 40%]
tests/unit/test_config.py::TestConfigManager::test_load_configuration_default_profile PASSED [ 43%]
tests/unit/test_config.py::TestConfigManager::test_load_configuration_with_profile PASSED [ 46%]
tests/unit/test_config.py::TestConfigManager::test_get_config_before_load_raises_error PASSED [ 50%]
tests/unit/test_config.py::TestConfigManager::test_get_api_key_from_keyring PASSED [ 53%]
tests/unit/test_config.py::TestConfigManager::test_set_api_key_with_persist PASSED [ 56%]
tests/unit/test_config.py::TestConfigManager::test_set_api_key_without_persist PASSED [ 60%]
tests/unit/test_config.py::TestConfigManager::test_set_invalid_provider_raises_error PASSED [ 63%]
tests/unit/test_config.py::TestConfigManager::test_delete_api_key PASSED [ 66%]
tests/unit/test_config.py::TestConfigManager::test_validate_missing_required_keys PASSED [ 70%]
tests/unit/test_config.py::TestConfigManager::test_validate_with_all_keys_set PASSED [ 73%]
tests/unit/test_config.py::TestConfigManager::test_get_config_summary_masked PASSED [ 76%]
tests/unit/test_config.py::TestConfigManager::test_get_config_summary_unmasked PASSED [ 80%]
tests/unit/test_config.py::TestConfigManager::test_set_custom_value PASSED [ 83%]
tests/unit/test_config.py::TestConfigManager::test_reload_configuration PASSED [ 86%]
tests/unit/test_config.py::TestConfigManager::test_profile_property PASSED [ 90%]
tests/unit/test_config.py::TestConfigurationIntegration::test_end_to_end_configuration_flow FAILED [ 93%]
tests/unit/test_config.py::TestConfigurationIntegration::test_keyring_fallback_to_env FAILED [ 96%]
tests/unit/test_config.py::TestConfigurationIntegration::test_keyring_overrides_env PASSED [100%]

=================================== FAILURES ===================================
_______ TestConfigurationIntegration.test_end_to_end_configuration_flow ________

self = <test_config.TestConfigurationIntegration object at 0x7f21fec560d0>
tmp_path = PosixPath('/tmp/pytest-of-keatonhoskins/pytest-1/test_end_to_end_configuration_0')

    def test_end_to_end_configuration_flow(self, tmp_path):
        """Test complete configuration workflow."""
        # 1. Initialize config manager
        config_manager = ConfigManager.get_instance()
    
        # 2. Load configuration
        env_file = tmp_path / ".env"
        env_file.write_text("ARIS_MAX_HOPS=3\n")
        config = config_manager.load(env_file=env_file)
    
        # 3. Validate (should fail - missing keys)
        validation = config_manager.validate()
        assert not validation["valid"]
    
        # 4. Set API keys
        config_manager.set_api_key("tavily", "tvly_key", persist=True)
        config_manager.set_api_key("anthropic", "ant_key", persist=True)
        config_manager.set_api_key("openai", "oai_key", persist=True)
    
        # 5. Validate again (should pass)
        validation = config_manager.validate()
        assert validation["valid"]
    
        # 6. Get config summary
        summary = config_manager.get_config_summary(mask_secrets=True)
>       assert "..." in summary["api_keys"]["tavily"]
E       AssertionError: assert '...' in '****'

tests/unit/test_config.py:446: AssertionError
__________ TestConfigurationIntegration.test_keyring_fallback_to_env ___________

self = <test_config.TestConfigurationIntegration object at 0x7f21fec56210>
tmp_path = PosixPath('/tmp/pytest-of-keatonhoskins/pytest-1/test_keyring_fallback_to_env0')

    def test_keyring_fallback_to_env(self, tmp_path):
        """Test that environment variables are used when keyring has no key."""
        # Set env var
        env_file = tmp_path / ".env"
        env_file.write_text("ARIS_TAVILY_API_KEY=env_key_123\n")
    
        config_manager = ConfigManager.get_instance()
        config = config_manager.load(env_file=env_file)
    
        # Should get key from environment
        key = config_manager.get_api_key("tavily")
>       assert key == "env_key_123"
E       AssertionError: assert None == 'env_key_123'

tests/unit/test_config.py:464: AssertionError
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.13.7-final-0 ________________

Name                                 Stmts   Miss  Cover
--------------------------------------------------------
src/aris/__init__.py                     2      0   100%
src/aris/cli/__init__.py                 0      0   100%
src/aris/cli/config_commands.py        235    235     0%
src/aris/cli/db_commands.py            232    232     0%
src/aris/cli/git_commands.py            43     43     0%
src/aris/cli/init_command.py            49     49     0%
src/aris/cli/main.py                    49     49     0%
src/aris/cli/organize_commands.py       16     16     0%
src/aris/cli/research_commands.py       21     21     0%
src/aris/cli/session_commands.py        29     29     0%
src/aris/cli/show_command.py            46     46     0%
src/aris/cli/status_command.py          51     51     0%
src/aris/core/config.py                128     17    87%
src/aris/core/secrets.py               108     33    69%
src/aris/models/__init__.py              5      0   100%
src/aris/models/config.py               45      1    98%
src/aris/models/document.py             68     25    63%
src/aris/models/research.py             82     12    85%
src/aris/models/source.py               49     11    78%
src/aris/storage/__init__.py             4      4     0%
src/aris/storage/database.py            79     79     0%
src/aris/storage/document_store.py      62     62     0%
src/aris/storage/git_manager.py        142    142     0%
src/aris/storage/models.py             139    139     0%
src/aris/storage/repositories.py       213    213     0%
src/aris/utils/__init__.py               2      2     0%
src/aris/utils/output.py                95     95     0%
--------------------------------------------------------
TOTAL                                 1994   1606    19%
Coverage HTML written to dir htmlcov
=========================== short test summary info ============================
FAILED tests/unit/test_config.py::TestConfigurationIntegration::test_end_to_end_configuration_flow - AssertionError: assert '...' in '****'
FAILED tests/unit/test_config.py::TestConfigurationIntegration::test_keyring_fallback_to_env - AssertionError: assert None == 'env_key_123'
========================= 2 failed, 28 passed in 1.69s =========================
