# ARIS Cost Tracking Architecture

## Current State (AS-IS)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ResearchOrchestrator                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ execute_research(query)                                â”‚ â”‚
â”‚  â”‚   1. Plan research strategy                            â”‚ â”‚
â”‚  â”‚   2. Execute hops (loop)                               â”‚ â”‚
â”‚  â”‚      - Call Tavily search                              â”‚ â”‚
â”‚  â”‚      - Analyze results                                 â”‚ â”‚
â”‚  â”‚      - Check confidence                                â”‚ â”‚
â”‚  â”‚   3. Generate final document                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                    USES (calls)
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TavilyClient                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ search(query)                                          â”‚ â”‚
â”‚  â”‚   - Make API request                                   â”‚ â”‚
â”‚  â”‚   - cost_tracker.record_operation("search", $0.01) âœ…  â”‚ â”‚
â”‚  â”‚   - Return results                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  Internal CostTracker (self.cost_tracker):                 â”‚
â”‚    - tracks operations                                     â”‚
â”‚    - accumulates total_cost                                â”‚
â”‚    - enforces budget (if set)                              â”‚
â”‚    - BUT: In-memory only, NOT persisted to DB âŒ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CostManager                            â”‚
â”‚  âš ï¸ EXISTS BUT NEVER INSTANTIATED âš ï¸                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ track_hop_cost() - NEVER CALLED                        â”‚ â”‚
â”‚  â”‚ check_budget_threshold() - NEVER CALLED                â”‚ â”‚
â”‚  â”‚ can_perform_operation() - NEVER CALLED                 â”‚ â”‚
â”‚  â”‚ get_session_summary() - NEVER CALLED                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                   SHOULD persist to
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Database (metadata.db)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ research_sessions:                                     â”‚ â”‚
â”‚  â”‚   - total_cost: 0.0 (always zero âŒ)                   â”‚ â”‚
â”‚  â”‚   - budget_target: set but unused                      â”‚ â”‚
â”‚  â”‚   - budget_warnings_issued: [] (empty)                 â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ research_hops:                                         â”‚ â”‚
â”‚  â”‚   - cost: null (never set âŒ)                          â”‚ â”‚
â”‚  â”‚   - llm_calls: 0 (never incremented)                  â”‚ â”‚
â”‚  â”‚   - total_tokens: 0 (never incremented)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**PROBLEM**: TavilyClient tracks costs internally, but:
1. âŒ Costs never saved to database
2. âŒ CostManager never instantiated
3. âŒ Budget warnings never triggered
4. âŒ Session costs always zero

---

## Desired State (TO-BE)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ResearchOrchestrator                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ __init__(config):                                      â”‚ â”‚
â”‚  â”‚   self.tavily_client = TavilyClient(...)              â”‚ â”‚
â”‚  â”‚   self.session_manager = SessionManager(...)          â”‚ â”‚
â”‚  â”‚   self.cost_manager = CostManager(session_manager) âœ…  â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ execute_research(query):                              â”‚ â”‚
â”‚  â”‚   1. Create session with budget_target                â”‚ â”‚
â”‚  â”‚   2. Loop through research hops:                      â”‚ â”‚
â”‚  â”‚      a. Check budget before hop âœ…                     â”‚ â”‚
â”‚  â”‚         if not cost_manager.can_perform_operation():  â”‚ â”‚
â”‚  â”‚            raise BudgetExceededError                  â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚      b. Execute hop (Tavily search, LLM analysis)     â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚      c. Track hop cost âœ…                              â”‚ â”‚
â”‚  â”‚         await cost_manager.track_hop_cost(            â”‚ â”‚
â”‚  â”‚            session_id,                                â”‚ â”‚
â”‚  â”‚            hop_number,                                â”‚ â”‚
â”‚  â”‚            tavily_searches=n,                         â”‚ â”‚
â”‚  â”‚            llm_tokens=tokens                          â”‚ â”‚
â”‚  â”‚         )                                             â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚      d. Check for budget warnings âœ…                   â”‚ â”‚
â”‚  â”‚         alert = await cost_manager.check_budget()     â”‚ â”‚
â”‚  â”‚         if alert: log warning                         â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚   3. Generate final document                          â”‚ â”‚
â”‚  â”‚   4. Save cost report âœ…                               â”‚ â”‚
â”‚  â”‚      await cost_manager.save_cost_report(session_id)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                  USES (orchestrates)
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TavilyClient       â”‚         â”‚    CostManager       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ search(query)  â”‚  â”‚         â”‚  â”‚ track_hop_cost â”‚  â”‚
â”‚  â”‚  - records op  â”‚  â”‚         â”‚  â”‚  - persist DB  â”‚  â”‚
â”‚  â”‚  - returns $   â”‚  â”‚         â”‚  â”‚  - check limit â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â”‚  - alert warn  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â†“
                                    PERSISTS TO
                                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Database (metadata.db)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ research_sessions:                                     â”‚ â”‚
â”‚  â”‚   - total_cost: 0.055 âœ… (actual accumulated cost)     â”‚ â”‚
â”‚  â”‚   - budget_target: 0.50                                â”‚ â”‚
â”‚  â”‚   - budget_warnings_issued: ["75% reached"] âœ…         â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ research_hops:                                         â”‚ â”‚
â”‚  â”‚   - cost: 0.015 âœ… (Tavily + LLM for this hop)         â”‚ â”‚
â”‚  â”‚   - llm_calls: 3 âœ… (number of Tavily searches)        â”‚ â”‚
â”‚  â”‚   - total_tokens: 1500 âœ… (LLM tokens used)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**SOLUTION**: Integrate CostManager into ResearchOrchestrator:
1. âœ… Instantiate CostManager in __init__
2. âœ… Pre-check budget before hops
3. âœ… Track costs after each hop
4. âœ… Save costs to database
5. âœ… Trigger budget warnings
6. âœ… Generate cost reports

---

## Cost Flow Diagram

```
User Query
    â†“
ResearchOrchestrator.execute_research()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pre-Hop Budget Check                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cost_manager.can_perform_operation(     â”‚
â”‚   session_id,                           â”‚
â”‚   estimated_cost=0.02,                  â”‚
â”‚   budget_limit=0.50                     â”‚
â”‚ )                                       â”‚
â”‚                                         â”‚
â”‚ Returns: True/False                     â”‚
â”‚ If False: Raise BudgetExceededError     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (if allowed)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Execute Hop                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. tavily_client.search(query)          â”‚
â”‚    - Tavily API call ($0.01)            â”‚
â”‚    - tavily_client.cost_tracker.record()â”‚
â”‚                                         â”‚
â”‚ 2. sequential_client.analyze(results)   â”‚
â”‚    - LLM API call (~1000 tokens)        â”‚
â”‚    - Returns analysis + token_count     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Post-Hop Cost Tracking                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cost_manager.track_hop_cost(            â”‚
â”‚   session_id="abc123",                  â”‚
â”‚   hop_number=1,                         â”‚
â”‚   tavily_searches=1,      # $0.01       â”‚
â”‚   llm_tokens=1000         # $0.01       â”‚
â”‚ )                                       â”‚
â”‚                                         â”‚
â”‚ Calculations:                           â”‚
â”‚   tavily_cost = 1 Ã— $0.01 = $0.01       â”‚
â”‚   llm_cost = (1000/1000) Ã— $0.01 = $0.01â”‚
â”‚   total_hop_cost = $0.02                â”‚
â”‚                                         â”‚
â”‚ Database Updates:                       â”‚
â”‚   research_hops[1].cost = 0.02          â”‚
â”‚   research_hops[1].llm_calls = 1        â”‚
â”‚   research_hops[1].total_tokens = 1000  â”‚
â”‚   research_sessions.total_cost += 0.02  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Budget Threshold Check                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cost_manager.check_budget_threshold(    â”‚
â”‚   session_id="abc123",                  â”‚
â”‚   budget_limit=0.50                     â”‚
â”‚ )                                       â”‚
â”‚                                         â”‚
â”‚ Calculates:                             â”‚
â”‚   percentage = 0.02 / 0.50 = 4%         â”‚
â”‚                                         â”‚
â”‚ Thresholds:                             â”‚
â”‚   75%+ : âš ï¸ Warning                     â”‚
â”‚   90%+ : âš ï¸âš ï¸ High Warning              â”‚
â”‚   100%+: ğŸš¨ Critical (hard block)       â”‚
â”‚                                         â”‚
â”‚ Returns: None (below threshold)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Continue to next hop (if confidence < target)
```

---

## Budget Enforcement Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Budget Configuration                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ArisConfig:                             â”‚
â”‚   - default_budget_quick: $0.20         â”‚
â”‚   - default_budget_standard: $0.50      â”‚
â”‚   - default_budget_deep: $2.00          â”‚
â”‚   - monthly_budget_limit: $50.00        â”‚
â”‚   - budget_limit: None (per-session)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Session Creation                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ session_manager.create_session(         â”‚
â”‚   query="AI research",                  â”‚
â”‚   budget_target=0.50  â† from config     â”‚
â”‚ )                                       â”‚
â”‚                                         â”‚
â”‚ Database:                               â”‚
â”‚   research_sessions.budget_target = 0.50â”‚
â”‚   research_sessions.total_cost = 0.00   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hop 1 Execution                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Cost: $0.02                             â”‚
â”‚ Total: $0.02 / $0.50 = 4% âœ…            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hop 2 Execution                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Cost: $0.03                             â”‚
â”‚ Total: $0.05 / $0.50 = 10% âœ…           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ... Continue hops ...                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hop 8 Execution                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Cost: $0.04                             â”‚
â”‚ Total: $0.38 / $0.50 = 76% âš ï¸           â”‚
â”‚                                         â”‚
â”‚ ALERT TRIGGERED: 75% threshold          â”‚
â”‚   - Log warning to console              â”‚
â”‚   - Save to session.budget_warnings     â”‚
â”‚   - Continue execution (not blocked)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hop 9 Execution                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Cost: $0.08                             â”‚
â”‚ Total: $0.46 / $0.50 = 92% âš ï¸âš ï¸         â”‚
â”‚                                         â”‚
â”‚ ALERT TRIGGERED: 90% threshold          â”‚
â”‚   - Log HIGH warning                    â”‚
â”‚   - Save to session.budget_warnings     â”‚
â”‚   - Continue execution (not blocked)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hop 10 Pre-Check                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Estimated cost: $0.06                   â”‚
â”‚ Projected total: $0.46 + $0.06 = $0.52  â”‚
â”‚ Budget limit: $0.50                     â”‚
â”‚                                         â”‚
â”‚ $0.52 > $0.50 â†’ BLOCKED ğŸš¨              â”‚
â”‚                                         â”‚
â”‚ can_perform_operation() returns False   â”‚
â”‚ raise BudgetExceededError               â”‚
â”‚                                         â”‚
â”‚ Research terminated early               â”‚
â”‚ Final cost: $0.46 / $0.50 (92%)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Monthly Budget Tracking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Monthly Budget Aggregation              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cost_manager.get_cost_history(days=30)  â”‚
â”‚                                         â”‚
â”‚ Query:                                  â”‚
â”‚   SELECT * FROM research_sessions       â”‚
â”‚   WHERE started_at >= NOW() - 30 days   â”‚
â”‚                                         â”‚
â”‚ Aggregations:                           â”‚
â”‚   - Total sessions: 15                  â”‚
â”‚   - Total cost: $12.45                  â”‚
â”‚   - Average per session: $0.83          â”‚
â”‚   - Daily breakdown: {...}              â”‚
â”‚                                         â”‚
â”‚ Daily Costs:                            â”‚
â”‚   2025-11-01: {sessions: 2, cost: 1.20} â”‚
â”‚   2025-11-02: {sessions: 1, cost: 0.50} â”‚
â”‚   2025-11-03: {sessions: 3, cost: 2.15} â”‚
â”‚   ...                                   â”‚
â”‚                                         â”‚
â”‚ Export Formats:                         â”‚
â”‚   - JSON: cost-history-YYYYMMDD.json    â”‚
â”‚   - CSV: cost-history-YYYYMMDD.csv      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema

```sql
CREATE TABLE research_sessions (
    id VARCHAR PRIMARY KEY,
    query TEXT NOT NULL,
    status VARCHAR,
    total_cost FLOAT DEFAULT 0.0,         â† Accumulated cost
    budget_target FLOAT NULL,              â† Budget limit for session
    budget_warnings_issued JSON DEFAULT [],â† ["75% reached", "90% reached"]
    started_at DATETIME,
    completed_at DATETIME NULL
);

CREATE TABLE research_hops (
    id INTEGER PRIMARY KEY,
    session_id VARCHAR REFERENCES research_sessions(id),
    hop_number INTEGER,
    cost FLOAT NULL,                       â† Cost for this hop
    llm_calls INTEGER DEFAULT 0,           â† Number of Tavily searches
    total_tokens INTEGER DEFAULT 0,        â† LLM tokens used
    completed_at DATETIME NULL
);

-- Cost Queries
SELECT SUM(total_cost) FROM research_sessions
WHERE started_at >= datetime('now', '-30 days');

SELECT
    DATE(started_at) as day,
    COUNT(*) as sessions,
    SUM(total_cost) as daily_cost
FROM research_sessions
WHERE started_at >= datetime('now', '-30 days')
GROUP BY DATE(started_at)
ORDER BY day DESC;

SELECT
    hop_number,
    cost,
    llm_calls,
    total_tokens
FROM research_hops
WHERE session_id = 'abc123'
ORDER BY hop_number;
```

---

## Integration Checklist

**To activate cost tracking, add to `ResearchOrchestrator`:**

```python
# In __init__(self, config):
from aris.core.cost_manager import CostManager

self.cost_manager = CostManager(
    session_manager=self.session_manager,
    cost_history_dir=config.research_dir / ".aris" / "cost-history"
)

# Before each hop:
can_proceed = await self.cost_manager.can_perform_operation(
    session_id=session.id,
    operation_cost=0.02,  # Estimate
    budget_limit=session.budget_target
)
if not can_proceed:
    raise BudgetExceededError("Budget exhausted")

# After each hop:
tavily_searches = 1  # Count from this hop
llm_tokens = analysis_result.get("token_count", 0)

breakdown, alert = await self.cost_manager.track_hop_cost(
    session_id=session.id,
    hop_number=current_hop,
    tavily_searches=tavily_searches,
    llm_tokens=llm_tokens
)

if alert:
    logger.warning(f"Budget alert: {alert.message}")

# At research completion:
await self.cost_manager.save_cost_report(session.id)
```

---

## Summary

**Current State**: Cost tracking infrastructure exists but is INACTIVE
**Problem**: CostManager never instantiated in ResearchOrchestrator
**Impact**: Costs not tracked, budgets not enforced, reports empty
**Solution**: 5-10 lines of integration code
**Effort**: 1-2 hours to integrate + test
**Value**: Full cost visibility and budget control
